set(LIBURING_CONFIG_HAVE_KERNEL_RWF_T    ON)
set(LIBURING_CONFIG_HAVE_KERNEL_TIMESPEC ON)
set(LIBURING_CONFIG_HAVE_OPEN_HOW        ON)
set(LIBURING_CONFIG_HAVE_STATX           ON)
set(LIBURING_CONFIG_HAVE_GLIBC_STATX     OFF)
set(LIBURING_CONFIG_HAVE_FUTEXV          ON)
set(LIBURING_CONFIG_HAVE_IDTYPE_T        ON)
set(LIBURING_CONFIG_HAVE_DISCARD_CMD     OFF)
set(LIBURING_CONFIG_USE_SANITIZER        OFF)

set(LIBURING_INCLUDE_DIR "${CMAKE_SOURCE_DIR}/third_party/liburing/src/include")
set(LIBURING_SOURCE_DIR "${CMAKE_SOURCE_DIR}/third_party/liburing/src")

set(SRCS
  "${LIBURING_SOURCE_DIR}/queue.c"
  "${LIBURING_SOURCE_DIR}/register.c"
  "${LIBURING_SOURCE_DIR}/setup.c"
  "${LIBURING_SOURCE_DIR}/syscall.c"
  "${LIBURING_SOURCE_DIR}/version.c"
)

add_compile_definitions(
  _GNU_SOURCE
  _LARGEFILE_SOURCE
  _FILE_OFFSET_BITS=64
  LIBURING_INTERNAL
)

set(LIBURING_COMPAT_INCLUDE_DIR "${CMAKE_BINARY_DIR}/third_party/liburing/src/include-compat")
set(LIBURING_COMPAT_HEADER "${LIBURING_COMPAT_INCLUDE_DIR}/liburing/compat.h")

configure_file(compat.h.in ${LIBURING_COMPAT_HEADER})

set(LIBURING_GENERATED_INCLUDE_DIR "${CMAKE_BINARY_DIR}/third_party/liburing/src/include")
set(LIBURING_VERSION_HEADER "${LIBURING_GENERATED_INCLUDE_DIR}/liburing/io_uring_version.h")

file(READ "${LIBURING_SOURCE_DIR}/../liburing.spec" LIBURING_SPEC)

string(REGEX MATCH "Version: ([0-9]+)\.([0-9]+)" _ ${LIBURING_SPEC})
set(LIBURING_VERSION_MAJOR ${CMAKE_MATCH_1})
set(LIBURING_VERSION_MINOR ${CMAKE_MATCH_2})

configure_file(io_uring_version.h.in ${LIBURING_VERSION_HEADER})

add_library(_uring ${SRCS})
add_library(uring::uring ALIAS _uring)

target_include_directories(_uring SYSTEM PUBLIC ${LIBURING_COMPAT_INCLUDE_DIR} ${LIBURING_GENERATED_INCLUDE_DIR} ${LIBURING_INCLUDE_DIR})
