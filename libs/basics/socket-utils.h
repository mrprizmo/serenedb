////////////////////////////////////////////////////////////////////////////////
/// DISCLAIMER
///
/// Copyright 2014-2023 ArangoDB GmbH, Cologne, Germany
/// Copyright 2004-2014 triAGENS GmbH, Cologne, Germany
///
/// Licensed under the Apache License, Version 2.0 (the "License");
/// you may not use this file except in compliance with the License.
/// You may obtain a copy of the License at
///
///     http://www.apache.org/licenses/LICENSE-2.0
///
/// Unless required by applicable law or agreed to in writing, software
/// distributed under the License is distributed on an "AS IS" BASIS,
/// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
/// See the License for the specific language governing permissions and
/// limitations under the License.
///
/// Copyright holder is ArangoDB GmbH, Cologne, Germany
////////////////////////////////////////////////////////////////////////////////

#pragma once

#include <stddef.h>

#include "basics/common.h"
#include "basics/operating-system.h"
#include "error_code.h"

#ifdef SERENEDB_HAVE_SYS_TYPES_H
#include <sys/types.h>
#endif
#ifdef SERENEDB_HAVE_SYS_SOCKET_H
#include <sys/socket.h>
#endif

#ifdef SERENEDB_HAVE_WINSOCK2_H
#include <WS2tcpip.h>
#include <WinSock2.h>

typedef long suseconds_t;
#endif

namespace sdb {

////////////////////////////////////////////////////////////////////////////////
/// socket types
////////////////////////////////////////////////////////////////////////////////

struct SocketWrapper {
  int file_descriptor;
};

////////////////////////////////////////////////////////////////////////////////
/// socket abstraction for different OSes
////////////////////////////////////////////////////////////////////////////////

inline SocketWrapper Sdbsocket(int domain, int type, int protocol) {
  SocketWrapper res;
  res.file_descriptor = socket(domain, type, protocol);
  return res;
}

////////////////////////////////////////////////////////////////////////////////
/// listen abstraction for different OSes
////////////////////////////////////////////////////////////////////////////////

inline int Sdblisten(SocketWrapper s, int backlog) {
  return listen(s.file_descriptor, backlog);
}

////////////////////////////////////////////////////////////////////////////////
/// bind abstraction for different OSes
////////////////////////////////////////////////////////////////////////////////

inline int Sdbbind(SocketWrapper s, const struct sockaddr* address,
                   size_t addr_len) {
  return bind(s.file_descriptor, address, (socklen_t)addr_len);
}

////////////////////////////////////////////////////////////////////////////////
/// connect abstraction for different OSes
////////////////////////////////////////////////////////////////////////////////

inline int Sdbconnect(SocketWrapper s, const struct sockaddr* address,
                      size_t addr_len) {
  return connect(s.file_descriptor, address, (socklen_t)addr_len);
}

////////////////////////////////////////////////////////////////////////////////
/// send abstraction for different OSes
////////////////////////////////////////////////////////////////////////////////

inline long Sdbsend(SocketWrapper s, const void* buffer, size_t length,
                    int flags) {
  return send(s.file_descriptor, buffer, length, flags);
}

////////////////////////////////////////////////////////////////////////////////
/// getsockopt abstraction for different OSes
////////////////////////////////////////////////////////////////////////////////

inline int Sdbgetsockopt(SocketWrapper s, int level, int optname, void* optval,
                         socklen_t* optlen) {
  return getsockopt(s.file_descriptor, level, optname, optval, optlen);
}

////////////////////////////////////////////////////////////////////////////////
/// setsockopt abstraction for different OSes
////////////////////////////////////////////////////////////////////////////////

inline int Sdbsetsockopt(SocketWrapper s, int level, int optname,
                         const void* optval, socklen_t optlen) {
  return setsockopt(s.file_descriptor, level, optname, optval, optlen);
}

////////////////////////////////////////////////////////////////////////////////
/// setsockopt abstraction for different OSes
////////////////////////////////////////////////////////////////////////////////

bool Sdbsetsockopttimeout(SocketWrapper s, double timeout);

////////////////////////////////////////////////////////////////////////////////
/// checks whether or not a socket is valid
////////////////////////////////////////////////////////////////////////////////

inline bool Sdbisvalidsocket(SocketWrapper s) {
  return s.file_descriptor != SERENEDB_INVALID_SOCKET;
}

////////////////////////////////////////////////////////////////////////////////
/// invalidates a socket
////////////////////////////////////////////////////////////////////////////////

inline void Sdbinvalidatesocket(SocketWrapper* s) {
  s->file_descriptor = SERENEDB_INVALID_SOCKET;
}

////////////////////////////////////////////////////////////////////////////////
/// get file descriptor or handle, depending on OS
///
/// Note that this returns the fileHandle under Windows which is exactly
/// the right thing we need in all but one places.
////////////////////////////////////////////////////////////////////////////////

inline int SdbgetFdOrHandleOfSocket(SocketWrapper s) {
  return s.file_descriptor;
}

////////////////////////////////////////////////////////////////////////////////
/// closes an open socket
////////////////////////////////////////////////////////////////////////////////

int Sdbclosesocket(SocketWrapper);

int Sdbreadsocket(SocketWrapper, void* buffer, size_t num_bytes_to_read,
                  int flags);

////////////////////////////////////////////////////////////////////////////////
/// sets non-blocking mode for a socket
////////////////////////////////////////////////////////////////////////////////

bool SdbSetNonBlockingSocket(SocketWrapper);

////////////////////////////////////////////////////////////////////////////////
/// sets close-on-exec for a socket
////////////////////////////////////////////////////////////////////////////////

bool SdbSetCloseOnExecSocket(SocketWrapper);

////////////////////////////////////////////////////////////////////////////////
/// translates for IPv4 address
///
/// This code is copyright Internet Systems Consortium, Inc. ("ISC")
////////////////////////////////////////////////////////////////////////////////

ErrorCode SdbInetPton4(const char* src, unsigned char* dst);

////////////////////////////////////////////////////////////////////////////////
/// translates for IPv6 address
///
/// This code is copyright Internet Systems Consortium, Inc. ("ISC")
////////////////////////////////////////////////////////////////////////////////

ErrorCode SdbInetPton6(const char* src, unsigned char* dst);

}  // namespace sdb
